<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>LED Controller</title>

<!-- Load Khmer fonts from local folders -->
<style>
@font-face { font-family: 'Bayon'; src: url('/Bayon/Bayon-Regular.ttf') format('truetype'); font-display: swap; }
@font-face { font-family: 'Bokor'; src: url('/Bokor/Bokor-Regular.ttf') format('truetype'); font-display: swap; }
@font-face { font-family: 'Koulen'; src: url('/Koulen/Koulen-Regular.ttf') format('truetype'); font-display: swap; }
@font-face { font-family: 'Moul'; src: url('/Moul/Moul-Regular.ttf') format('truetype'); font-display: swap; }

:root {
  --bg: #0b1220;
  --glass: rgba(255,255,255,.06);
  --muted: #a8b3c7;
  --accent: #06b6d4;
  --r: 16px;
}
* { box-sizing: border-box; }
html,body {
  height:100%;margin:0;
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Siemreap,Arial;
  background:radial-gradient(1200px 800px at 20% -10%, #132036 0%, rgba(10,16,30,0) 60%),linear-gradient(180deg,#081120,#03070f);
  color:#eaf2fb;
}
.wrap{max-width:980px;margin:18px auto;padding:16px}
header{display:flex;gap:10px;align-items:center;margin-bottom:16px}
h1{font-size:18px;margin:0;font-weight:700;letter-spacing:.3px}
.pill{font-size:12px;padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid rgba(255,255,255,.1)}
.status{margin-left:auto;padding:6px 10px;border-radius:999px;background:var(--glass);font-size:12px;border:1px solid rgba(255,255,255,.08)}
.card{border-radius:var(--r);padding:18px; margin-top: 8px ;border:1px solid rgba(255,255,255,.08);background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.03));box-shadow:0 8px 30px rgba(0,0,0,.3);backdrop-filter:blur(8px)}

/* Tabs */
.tabs{display:flex;gap:8px;margin-bottom:12px}
.tab-btn{flex:1;padding:10px 14px;border-radius:12px;background:var(--glass);border:1px solid rgba(255,255,255,.12);color:var(--muted);font-weight:600;cursor:pointer;transition:all .2s}
.tab-btn.active{background:var(--accent);color:#02182b}
.tab-content{display:none;animation:fadeIn .25s ease}
.tab-content.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* Inputs */
label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
textarea,select,input[type="color"],input[type="range"],input[type="file"]{
  width:100%;padding:10px;border-radius:10px;background:transparent;
  border:1px solid rgba(255,255,255,.12);color:inherit;font-size:14px
}
select{background-color:#1a2536;color:#e5e5e5;}

/* Color Picker */
input[type="color"]{-webkit-appearance:none;height:44px;border-radius:12px;cursor:pointer;padding:0;border:none;outline:1px solid rgba(255,255,255,.12)}
input[type="color"]::-webkit-color-swatch-wrapper{padding:4px}
input[type="color"]::-webkit-color-swatch{border-radius:10px;border:none}

/* Buttons */
.btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:var(--accent);color:#02182b;font-weight:700;cursor:pointer;transition:all .2s}
.btn:hover{filter:brightness(1.1);}
.btn.ghost{background:rgba(255,255,255,.06);color:#cfe9f2}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:10px}
.grid.two{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.grid.three{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
@media(max-width:720px){.grid.two,.grid.three{grid-template-columns:1fr}}

/* Toggles */
.control-bar{display:flex;gap:14px;align-items:center;justify-content:flex-start;margin:16px 0;flex-wrap:wrap}
.toggle{display:inline-flex;align-items:center;gap:8px;background:var(--glass);padding:8px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:13px}
.toggle input{appearance:none;width:40px;height:22px;border-radius:999px;background:#0a1a2a;position:relative;outline:none;border:1px solid rgba(255,255,255,.18)}
.toggle input:checked{background:#0d253a}
.toggle input::after{content:"";position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:999px;background:white;transition:all .18s}
.toggle input:checked::after{left:20px}

canvas{width:100%;max-width:640px;aspect-ratio:4/1;background:#000;border-radius:12px;border:1px solid rgba(255,255,255,.08)}
.log{max-height:180px;overflow:auto;background:rgba(2,6,23,.45);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;font:12px ui-monospace,Menlo,Consolas,monospace}


/* --- Image Upload Box --- */
.upload-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-align: center;
  gap: 16px;
}

.upload-box {
  position: relative;
  width: 100%;
  max-width: 90%;
  height: 130px;
  border: 2px dashed rgba(255,255,255,0.2);
  border-radius: 16px;
  background: rgba(255,255,255,0.04);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: var(--muted);
  font-size: 14px;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 6px 20px rgba(0,0,0,0.25);
}

.upload-box:hover {
  background: rgba(255,255,255,0.08);
  border-color: var(--accent);
  color: var(--accent);
  transform: translateY(-2px);
}

.upload-icon {
  font-size: 36px;
  opacity: 0.8;
  margin-bottom: 8px;
}

.upload-box input[type="file"] {
  position: absolute;
  inset: 0;
  width: 100%;
  height: 100%;
  opacity: 0;
  cursor: pointer;
}

.upload-text span {
  display: block;
  font-size: 12px;
  color: rgba(255,255,255,0.5);
  margin-top: 2px;
}

.upload-info {
  font-size: 13px;
  color: #a8b3c7;
  background: rgba(255,255,255,0.05);
  padding: 6px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.1);
  width: fit-content;
  margin-bottom: 10px;
}

.upload-btn {
  width: 100%;
  max-width: 400px;
  padding: 12px;
  font-weight: 700;
}

</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>LED Text & Image</h1>
    <span class="pill">Matrix <strong id="matrixSize">128√ó32</strong></span>
    <span class="pill">WS <code id="wsUri"></code></span>
    <div id="wsStatus" class="status">WS: disconnected</div>
  </header>

  <section class="card">
    <div class="tabs">
      <button class="tab-btn active" data-tab="textTab">Text</button>
      <button class="tab-btn" data-tab="imageTab">Image</button>
    </div>

    <div id="textTab" class="tab-content active">
      <label for="textInput">Message</label>
      <textarea id="textInput" rows="3" style="font-family:'Bayon','Siemreap';">·ûü·ûº·ûò·ûü·üí·ûú·û∂·ûÇ·ûò·ûì·üç üé∂ Hello üåè</textarea>

      <div class="grid three">
        <div>
          <label for="fontSelect">Font</label>
          <select id="fontSelect">
            <option value="Bayon" selected>Bayon</option>
            <option value="Bokor">Bokor</option>
            <option value="Koulen">Koulen</option>
            <option value="Moul">Moul</option>
            <option value="Noto Sans">Noto Sans</option>
            <option value="Noto Color Emoji">Noto Color Emoji</option>
          </select>
        </div>
        <div>
          <label for="fontSize">Font size (pt): <span id="fontSizeValue">15</span></label>
          <input id="fontSize" type="range" min="8" max="40" value="15">
        </div>
        <div>
          <label for="yOffset">Y-offset (px): <span id="yOffsetValue">0</span></label>
          <input id="yOffset" type="range" min="-16" max="16" value="0">
        </div>
      </div>

      <div class="grid three">
        <div>
          <label for="fgColor">Text color</label>
          <input id="fgColor" type="color" value="#FFFFFF">
        </div>
        <div>
          <label for="fgColor2">Gradient End</label>
          <input id="fgColor2" type="color" value="#FF00FF">
        </div>
        <div>
          <label for="bgColor">Background</label>
          <input id="bgColor" type="color" value="#000000">
        </div>
      </div>

      <div class="grid two">
        <div>
          <label for="gradientDir">Gradient Direction</label>
          <select id="gradientDir">
            <option value="horizontal" selected>Horizontal</option>
            <option value="vertical">Vertical</option>
          </select>
        </div>
      </div>

      <div class="row">
        <button id="previewBtn" class="btn ghost">Preview</button>
        <button id="sendTextBtn" class="btn">Send Text ‚Üí ESP32</button>
      </div>
    </div>

    <div id="imageTab" class="tab-content">
      <div class="upload-container">
        <label for="imageFile">Upload Image</label>
        <div class="upload-box">
          <div class="upload-icon">üìÅ</div>
          <p class="upload-text">Drag & drop your image here<br><span>or click to browse</span></p>
          <input id="imageFile" type="file" accept="image/*">
        </div>
        <div class="upload-info" id="fileInfo">No file selected</div>
        <button id="sendImageBtn" class="btn upload-btn">Send Image ‚Üí ESP32</button>
      </div>
    </div>

  </section>

  <!-- CONTROL BAR -->
  <div class="control-bar card">
    <div class="toggle"><span>Scroll</span><input id="scrollToggle" type="checkbox" checked></div>
    <div class="toggle"><span>Sparkles</span><input id="bgNoise" type="checkbox"></div>
    <div class="toggle"><span>Use Gradient</span><input id="useGradient" type="checkbox" checked></div>
  </div>

  <section class="card">
    <div class="sub">Preview</div>
    <canvas id="previewCanvas" width="512" height="128"></canvas>
  </section>

  <section class="card">
    <div class="sub">Status</div>
    <div id="log" class="log"></div>
  </section>
</div>

<script>
(function(){
  const wsStatus=document.getElementById('wsStatus');
  const logBox=document.getElementById('log');
  const fgColor=document.getElementById('fgColor');
  const bgColor=document.getElementById('bgColor');
  const fgColor2=document.getElementById('fgColor2');
  const useGradient=document.getElementById('useGradient');
  const gradientDir=document.getElementById('gradientDir');
  const textInput=document.getElementById('textInput');
  const fontSelect=document.getElementById('fontSelect');
  const fontSize=document.getElementById('fontSize');
  const fontSizeValue=document.getElementById('fontSizeValue');
  const yOffset=document.getElementById('yOffset');
  const yOffsetValue=document.getElementById('yOffsetValue');
  const scrollToggle=document.getElementById('scrollToggle');
  const bgNoise=document.getElementById('bgNoise');
  const previewBtn=document.getElementById('previewBtn');
  const sendTextBtn=document.getElementById('sendTextBtn');
  const imageFile=document.getElementById('imageFile');
  const sendImageBtn=document.getElementById('sendImageBtn');
  const canvas=document.getElementById('previewCanvas');
  const ctx=canvas.getContext('2d');

  function log(msg,lvl="info"){
    const t=new Date().toLocaleTimeString();
    const color=lvl==="error"?"#ef4444":lvl==="warn"?"#eab308":"#a8b3c7";
    logBox.innerHTML=`<div style="color:${color}">[${t}] ${msg}</div>`+logBox.innerHTML;
  }

  // ‚úÖ Add this tab switching logic
  document.querySelectorAll(".tab-btn").forEach(btn=>{
    btn.onclick=()=>{
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    };
  });

  fontSize.oninput=()=>{fontSizeValue.textContent=fontSize.value; drawPreview();};

  fontSize.oninput=()=>{fontSizeValue.textContent=fontSize.value; drawPreview();};
  yOffset.oninput=()=>{yOffsetValue.textContent=yOffset.value; drawPreview();};
  fontSelect.onchange=()=>{ textInput.style.fontFamily=fontSelect.value; drawPreview(); };
  fgColor.oninput=drawPreview; fgColor2.oninput=drawPreview;
  bgColor.oninput=drawPreview; useGradient.onchange=drawPreview;
  gradientDir.onchange=drawPreview;

  let ws=null,reconnectTimer=null;
  function connectWS(){
    const WS_URI=(location.protocol==="https:"?"wss://":"ws://")+location.host+"/ws";
    document.getElementById('wsUri').textContent=WS_URI;
    ws=new WebSocket(WS_URI,["browser"]);
    ws.binaryType="arraybuffer";
    ws.onopen=()=>{wsStatus.textContent="WS: connected";wsStatus.style.background="rgba(22,163,74,.22)";log("WebSocket connected ‚úÖ");ws.send(JSON.stringify({type:"hello",role:"browser"}));};
    ws.onmessage=(ev)=>{try{const j=JSON.parse(ev.data);if(j.type==="status")log(j.message,j.level||"info");}catch(e){console.warn("WS parse error",e);}};
    ws.onerror=()=>log("WebSocket error ‚ö†Ô∏è","error");
    ws.onclose=()=>{wsStatus.textContent="WS: disconnected";wsStatus.style.background="";log("WebSocket closed, retrying in 2s‚Ä¶","warn");clearTimeout(reconnectTimer);reconnectTimer=setTimeout(connectWS,2000);};
  } connectWS();

  function drawPreview(){
    ctx.fillStyle=bgColor.value;
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.font=`${fontSize.value}px '${fontSelect.value}', 'Siemreap', sans-serif`;
    ctx.textBaseline="middle";
    const text=textInput.value;
    let fill=fgColor.value;
    if(useGradient.checked){
      const grad=gradientDir.value==="vertical"?ctx.createLinearGradient(0,0,0,canvas.height):ctx.createLinearGradient(0,0,canvas.width,0);
      grad.addColorStop(0,fgColor.value);grad.addColorStop(1,fgColor2.value);fill=grad;
    }
    ctx.fillStyle=fill;
    ctx.fillText(text,10,canvas.height/2+parseInt(yOffset.value,10));
  }
  previewBtn.onclick=drawPreview;

  sendTextBtn.onclick=()=>{
    if(!ws||ws.readyState!==WebSocket.OPEN){alert("WebSocket not connected");return;}
    ws.send(JSON.stringify({
      type:"command",action:"render_and_send",
      text:textInput.value,font_family:fontSelect.value,font_size_pt:Number(fontSize.value),
      fg_color:fgColor.value,fg_color2:fgColor2.value,bg_color:bgColor.value,
      width:128,height:32,y_offset:Number(yOffset.value),
      animate:(scrollToggle.checked?"scroll":"static"),
      bg_noise:bgNoise.checked,use_gradient:useGradient.checked,gradient_dir:gradientDir.value
    }));
    log("Text command sent ‚úÖ");
  };

  sendImageBtn.onclick=async()=>{
    if(!ws||ws.readyState!==WebSocket.OPEN){alert("WebSocket not connected");return;}
    const file=imageFile.files[0];if(!file){alert("Select image first");return;}
    const bmp=await createImageBitmap(file);
    const off=document.createElement('canvas');off.width=128;off.height=32;
    const c2d=off.getContext('2d',{willReadFrequently:true});
    c2d.fillStyle="#000";c2d.fillRect(0,0,off.width,off.height);
    const scale=Math.min(off.width/bmp.width,off.height/bmp.height);
    const w=bmp.width*scale,h=bmp.height*scale;
    const x=(off.width-w)/2,y=(off.height-h)/2;
    c2d.drawImage(bmp,x,y,w,h);
    const idata=c2d.getImageData(0,0,off.width,off.height);
    const buf=new ArrayBuffer(4+off.width*off.height*2);
    const dv=new DataView(buf);
    dv.setUint16(0,off.width,true);dv.setUint16(2,off.height,true);
    const px=new Uint8Array(buf,4);let p=0;
    for(let i=0;i<idata.data.length;i+=4){
      const r=idata.data[i],g=idata.data[i+1],b=idata.data[i+2];
      const rgb565=((r&0xF8)<<8)|((g&0xFC)<<3)|(b>>3);
      px[p++]=rgb565&0xFF;px[p++]=rgb565>>8;
    }
    ws.send(buf);
    log(`Image sent (${off.width}√ó${off.height}) ‚úÖ`);
  };
})();
</script>
</body>
</html>
